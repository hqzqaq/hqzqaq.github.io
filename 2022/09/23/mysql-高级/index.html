<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
        
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>mysql 高级 |  hqz的博客</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="https://cdn.staticfile.org/mermaid/8.14.0/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    </head>
  </html>
</html>


<body>
  <div id="app">
    
      
      <canvas width="1777" height="841"
        style="position: fixed; left: 0px; top: 0px; z-index: 99999; pointer-events: none;"></canvas>
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-mysql-高级"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  mysql 高级
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2022/09/23/mysql-%E9%AB%98%E7%BA%A7/" class="article-date">
  <time datetime="2022-09-23T05:50:47.000Z" itemprop="datePublished">2022-09-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">5.5k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">20 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>  <font style="color:#10661E;font-size:50px">MySQL高级</font></p>
<h1 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h1><blockquote>
<p>A：原子性，由 undo log 日志保证，它记录了需要回滚的日志信息，事务回滚时撤销已经执行成功的sql</p>
<p>C：一致性，由其它三大特征保证，程序代码要保证业务上的一致性</p>
<p>I：隔离性，由 MVCC 来保证</p>
<p>D：持久性，由内存 + redo log 来保证，mysql 修改数据，同时在内存和 redo log 记录这次操作，宕机的时候可以从 redo log 恢复</p>
</blockquote>
<span id="more"></span>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">InnoDB redo log 写盘，InnoDB 事务进入 prepare 状态。</span><br><span class="line">如果前面 prepare 成功，binlog 写盘，再继续将事务日志持久化到 binlog，如果持久化成功，那么 InnoDB 事务则进入 commit 状态（在 redo log 里面写一个 commit 记录）</span><br></pre></td></tr></table></figure>



<p>redo log 的刷盘会在系统空闲时进行。</p>
<h1 id="mysql-的结构介绍"><a href="#mysql-的结构介绍" class="headerlink" title="mysql 的结构介绍"></a>mysql 的结构介绍</h1><ol>
<li>mysql 内核</li>
<li>sql 优化工程师</li>
<li>mysql 服务器的优化</li>
<li>各种参数常量设定</li>
<li>查询语句优化</li>
<li>主从复制</li>
<li>软硬件升级</li>
<li>容灾备份</li>
<li>sql 编程</li>
</ol>
<h2 id="1、mysql-文件目录"><a href="#1、mysql-文件目录" class="headerlink" title="1、mysql 文件目录"></a>1、mysql 文件目录</h2><table>
<thead>
<tr>
<th>路径</th>
<th>解释</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;</td>
<td>mysql 数据库文件的存放路径</td>
<td>&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;atguigu.cloud.pid</td>
</tr>
<tr>
<td>&#x2F;usr&#x2F;share&#x2F;mysql</td>
<td>配置文件目录</td>
<td>mysql.server 命令及配置文件</td>
</tr>
<tr>
<td>&#x2F;usr&#x2F;bin</td>
<td>相关命令目录</td>
<td>mysqladmin mysqldump 等命令</td>
</tr>
<tr>
<td>&#x2F;etc&#x2F;init.d&#x2F;mysql</td>
<td>启停相关脚本</td>
<td></td>
</tr>
</tbody></table>
<h2 id="2、修改配置文件"><a href="#2、修改配置文件" class="headerlink" title="2、修改配置文件"></a>2、修改配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># windows 上为 my.ini 文件</span></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置字符编码</span></span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">character_set_server=utf8</span><br><span class="line">character_set_client=utf8</span><br><span class="line">collation-server=utf8_general_ci</span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引缓冲大小</span></span><br><span class="line">sort_buffer_size =</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="3、日志文件"><a href="#3、日志文件" class="headerlink" title="3、日志文件"></a>3、日志文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主从复制</span></span><br><span class="line">log-bin=[path]</span><br><span class="line">log-err=[path]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认是关闭的，记录严重的警告和错误信息，每次启动和关闭的详细信息等</span></span><br><span class="line">log-error=[path]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询日志，默认关闭，记录查询的 sql 语句，如果开启会降低 mysql 的整体性能，因为记录日志也是需要消耗系统资源的</span></span><br><span class="line"><span class="built_in">log</span>=</span><br></pre></td></tr></table></figure>



<h2 id="4、数据文件"><a href="#4、数据文件" class="headerlink" title="4、数据文件"></a>4、数据文件</h2><ul>
<li>frm 文件：存放表结构</li>
<li>myd 文件：存放表数据</li>
<li>myi 文件：存放表索引</li>
</ul>
<h1 id="mysql-架构"><a href="#mysql-架构" class="headerlink" title="mysql 架构"></a>mysql 架构</h1><p>MySQL 可以在多种不同场景中应用并发挥良好作用，主要体现在<code>存储引擎的架构</code>上，<code>插件式的存储引擎架构</code>将<font color="orange">查询处理</font>和<font color="orange">其它的系统任务</font>以及<font color="orange">数据的存储提取</font><code>相分离</code>，这种架构可以<font color="yellow">根据业务的需求和实际需要</font><code>选择合适的存储引擎</code>。</p>
<p><img src="https://i.loli.net/2021/10/26/dcQIJUusMONipeh.png" alt="MySQL 架构"></p>
<h2 id="5、连接层"><a href="#5、连接层" class="headerlink" title="5、连接层"></a>5、连接层</h2><p>最上层是一些客户端和连接服务，包含本地 sock 通信和大多数基于客户端&#x2F;服务端工具实现的类似于 <code>tcp/ip</code> 的通信。主要完成一些类似于<code>连接处理</code>、<code>授权认证</code>及相关的<code>安全方案</code>。在该层上引入了<code>线程池</code>的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于 <code>SSL</code> 的安全链接。服务器也会安全接入的每个客户端验证它所具有的操作权限。</p>
<h2 id="6、服务层"><a href="#6、服务层" class="headerlink" title="6、服务层"></a>6、服务层</h2><p>第二层架构主要完成大多数的核心服务功能，如 <code>SQL 接口</code>，并完成<code>缓存的查询</code>，<code>SQL 的分析和优化</code>及<code>部分内置函数的执行</code>。所有<code>跨存储引擎</code>的功能也在这一层实现，如过程、函数等。在该层，服务器会解析查询并创建相应的<code>内部解析树</code>，并对其完成相应的<font color="yellow">优化</font>，如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作。如果是 select 语句，服务器还会<code>查询内部的缓存</code>。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。</p>
<h2 id="7、引擎层"><a href="#7、引擎层" class="headerlink" title="7、引擎层"></a>7、引擎层</h2><p>存储引擎层，存储引擎真正的负责了 MySQL 中<code>数据的存储和提取</code>，服务器通过<code>API</code>与<code>存储引擎</code>进行<font color="yellow">通信</font>。不同的存储引擎具有的功能不同，这样我们<font color="yellow">可以根据自己的实际需要进行选取</font>。</p>
<h2 id="8、存储层"><a href="#8、存储层" class="headerlink" title="8、存储层"></a>8、存储层</h2><p>数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互</p>
<h2 id="9、MyISAM-和-InnoDB-引擎对比"><a href="#9、MyISAM-和-InnoDB-引擎对比" class="headerlink" title="9、MyISAM 和 InnoDB 引擎对比"></a>9、MyISAM 和 InnoDB 引擎对比</h2><table>
<thead>
<tr>
<th>对比项</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>主外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>行表锁</td>
<td>表锁，即只操作一条记录也会锁住整个表，不适合高并发的操作<br><font color="red">适合读的操作</font></td>
<td>行锁，操作时只锁某一行，不对其它行有影响<br><font color="red">适合高并发操作</font></td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引，不缓存真实数据</td>
<td>不仅缓存索引，还要缓存真实数据，对内存要求较高，而且内存<br>大小对性能有决定性的影响</td>
</tr>
<tr>
<td>表空间</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>关注点</td>
<td>性能</td>
<td>事务</td>
</tr>
<tr>
<td>默认安装</td>
<td>YES</td>
<td>YES</td>
</tr>
</tbody></table>
<h1 id="索引优化分析"><a href="#索引优化分析" class="headerlink" title="索引优化分析"></a>索引优化分析</h1><h2 id="10、sql-执行慢的原因"><a href="#10、sql-执行慢的原因" class="headerlink" title="10、sql 执行慢的原因"></a>10、sql 执行慢的原因</h2><h3 id="10-1、单值索引"><a href="#10-1、单值索引" class="headerlink" title="10.1、单值索引"></a>10.1、单值索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> email <span class="operator">=</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在 user 表中的 name 字段上建立索引</span></span><br><span class="line"><span class="keyword">create</span> index idx_user_name <span class="keyword">on</span> <span class="keyword">user</span>(name);</span><br></pre></td></tr></table></figure>



<h3 id="10-2、复合索引"><a href="#10-2、复合索引" class="headerlink" title="10.2、复合索引"></a>10.2、复合索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在 user 表中的 name 和 email 字段上建立索引</span></span><br><span class="line"><span class="keyword">create</span> index idx_user_nameEmail <span class="keyword">on</span> <span class="keyword">user</span>(name,email);</span><br></pre></td></tr></table></figure>



<h3 id="10-3、关联查询太多-join"><a href="#10-3、关联查询太多-join" class="headerlink" title="10.3、关联查询太多 join"></a>10.3、关联查询太多 join</h3><h3 id="10-4、服务器调优及各个参数的设置（缓冲、线程数）"><a href="#10-4、服务器调优及各个参数的设置（缓冲、线程数）" class="headerlink" title="10.4、服务器调优及各个参数的设置（缓冲、线程数）"></a>10.4、服务器调优及各个参数的设置（缓冲、线程数）</h3><h2 id="11、常见的通用的-join-查询"><a href="#11、常见的通用的-join-查询" class="headerlink" title="11、常见的通用的 join 查询"></a>11、常见的通用的 join 查询</h2><h3 id="11-1、SQL-执行顺序"><a href="#11-1、SQL-执行顺序" class="headerlink" title="11.1、SQL 执行顺序"></a>11.1、SQL 执行顺序</h3><h4 id="11-1-1、手写"><a href="#11-1-1、手写" class="headerlink" title="11.1.1、手写"></a>11.1.1、手写</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span></span><br><span class="line">	<span class="operator">&lt;</span>select_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">	<span class="operator">&lt;</span>left_table<span class="operator">&gt;</span> <span class="operator">&lt;</span>join_type<span class="operator">&gt;</span></span><br><span class="line"> <span class="keyword">JOIN</span> <span class="operator">&lt;</span>right_table<span class="operator">&gt;</span> <span class="keyword">On</span> <span class="operator">&lt;</span>join_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="operator">&lt;</span>where_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>group_by_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="operator">&lt;</span>having_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>order_by_condition<span class="operator">&gt;</span></span><br><span class="line">LIMIT <span class="operator">&lt;</span>limit_number<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="11-1-2、机读"><a href="#11-1-2、机读" class="headerlink" title="11.1.2、机读"></a>11.1.2、机读</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> <span class="operator">&lt;</span>left_table<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">On</span> <span class="operator">&lt;</span>join_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span>join_type<span class="operator">&gt;</span> <span class="keyword">JOIN</span> <span class="operator">&lt;</span>right_table<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="operator">&lt;</span>where_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>group_by_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">HAVING</span> <span class="operator">&lt;</span>having_condition<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="keyword">DISTINCT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">&lt;</span>order_by_condition<span class="operator">&gt;</span></span><br><span class="line">LIMIT <span class="operator">&lt;</span>limit_number<span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>





<h3 id="11-2、7-中-join"><a href="#11-2、7-中-join" class="headerlink" title="11.2、7 中 join"></a>11.2、7 中 join</h3><img src="https://i.loli.net/2021/11/03/VcAqBDeKNPpbofk.jpg" alt="sqljoin_clear" style="zoom: 33%;">



<h4 id="11-2-1、INNER-JOIN-内连接"><a href="#11-2-1、INNER-JOIN-内连接" class="headerlink" title="11.2.1、INNER JOIN 内连接"></a>11.2.1、INNER JOIN 内连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A、B 表的共有</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="keyword">TABLE</span> B B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-2、LEFT-JOIN-左连接"><a href="#11-2-2、LEFT-JOIN-左连接" class="headerlink" title="11.2.2、LEFT JOIN 左连接"></a>11.2.2、LEFT JOIN 左连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A 表的独有 加 A、B 表的共有</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-3、RIGHT-JOIN-右连接"><a href="#11-2-3、RIGHT-JOIN-右连接" class="headerlink" title="11.2.3、RIGHT JOIN 右连接"></a>11.2.3、RIGHT JOIN 右连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- B 表的独有 加 A、B 表的共有</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-4、左外部连接"><a href="#11-2-4、左外部连接" class="headerlink" title="11.2.4、左外部连接"></a>11.2.4、左外部连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A 表的独有</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key <span class="keyword">WHERE</span> B.key <span class="keyword">is</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-5、右外部连接"><a href="#11-2-5、右外部连接" class="headerlink" title="11.2.5、右外部连接"></a>11.2.5、右外部连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- B 表的独有</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key <span class="keyword">WHERE</span> A.key <span class="keyword">is</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-6、全连接"><a href="#11-2-6、全连接" class="headerlink" title="11.2.6、全连接"></a>11.2.6、全连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A、B 的合并</span></span><br><span class="line"><span class="comment">-- MySQL 中无法体现</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> <span class="keyword">TABLE</span> B B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key;</span><br><span class="line"><span class="comment">-- 使用 union</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key;</span><br><span class="line"><span class="keyword">union</span> <span class="comment">-- 自带去重</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key;</span><br></pre></td></tr></table></figure>



<h4 id="11-2-7、全外部连接"><a href="#11-2-7、全外部连接" class="headerlink" title="11.2.7、全外部连接"></a>11.2.7、全外部连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- A 的独有 + B 的独有</span></span><br><span class="line"><span class="comment">-- MySQL 中无法体现</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> <span class="keyword">TABLE</span> B B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key <span class="keyword">WHERE</span> A.Key I <span class="keyword">NULL</span> <span class="keyword">OR</span> B.Key <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key <span class="keyword">WHERE</span> B.key <span class="keyword">is</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">&lt;</span>select_list<span class="operator">&gt;</span> <span class="keyword">FROM</span> TableA A <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> TableB B <span class="keyword">ON</span> A.Key <span class="operator">=</span> B.Key <span class="keyword">WHERE</span> A.key <span class="keyword">is</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>



<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="12、概述"><a href="#12、概述" class="headerlink" title="12、概述"></a>12、概述</h2><blockquote>
<p>索引（Index）：是帮助 MySQL 高效获取数据的数据结构。索引的目的在于提高查询效率，可以类比字典。</p>
<p>索引是一种数据结构。可以理解为 排好序的快速查找数据结构。</p>
<p>索引会影响 where 查询的条件 和 order by 的排序。</p>
<p>数据本身之外，数据库还维护着一个满足<strong>特定查找算法</strong>的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现<strong>高级查找算法</strong>，这种数据结构就是索引（B树）</p>
</blockquote>
<p>一般索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式<strong>存储在磁盘上</strong>。</p>
<h2 id="13、优势"><a href="#13、优势" class="headerlink" title="13、优势"></a>13、优势</h2><ol>
<li>类似大学图书馆建书目索引，提高数据检索的效率，降低数据库的 IO 成本</li>
<li>通过索引列对数据进行了<font color="yellow">排序</font>，降低数据排序的成本，降低了 CPU 的消耗</li>
</ol>
<h2 id="14、劣势"><a href="#14、劣势" class="headerlink" title="14、劣势"></a>14、劣势</h2><ol>
<li>实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的</li>
<li>虽然索引大大提高了查询速度，同时却<font color="orange">会降低更新表的速度</font>，如对表进行 INSERT、UPDATE 和 DELETE。因为更新表时，MySQL 不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息。</li>
</ol>
<h2 id="15、mysql-索引分类"><a href="#15、mysql-索引分类" class="headerlink" title="15、mysql 索引分类"></a>15、mysql 索引分类</h2><p><font color="red">一张表的索引最好不要超过 5 个<br></font></p>
<h3 id="15-1、单值索引"><a href="#15-1、单值索引" class="headerlink" title="15.1、单值索引"></a>15.1、单值索引</h3><p><strong>即一个索引只包含单个列，一个表可以有多个单列</strong></p>
<h3 id="15-2、唯一索引"><a href="#15-2、唯一索引" class="headerlink" title="15.2、唯一索引"></a>15.2、唯一索引</h3><p>索引列的值必须唯一，但允许有空值</p>
<h3 id="15-3、复合索引"><a href="#15-3、复合索引" class="headerlink" title="15.3、复合索引"></a>15.3、复合索引</h3><p>即一个索引包含多个列，<font color="orange">复合索引一般优于单值索引</font></p>
<h3 id="15-4、基本语法"><a href="#15-4、基本语法" class="headerlink" title="15.4、基本语法"></a>15.4、基本语法</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 增加</span></span><br><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">UNIQUE</span>] INDEX indexName <span class="keyword">ON</span> myTable(columnName(length));</span><br><span class="line"><span class="keyword">ALTER</span> myTable <span class="keyword">ADD</span> [<span class="keyword">UNIQUE</span>] INDEX [indexName] <span class="keyword">ON</span> (columnName(length));</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除</span></span><br><span class="line"><span class="keyword">DROP</span> INDEX [indexName] <span class="keyword">ON</span> myTable;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看</span></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> myTable;</span><br></pre></td></tr></table></figure>





<h2 id="16、mysql-索引结构"><a href="#16、mysql-索引结构" class="headerlink" title="16、mysql 索引结构"></a>16、mysql 索引结构</h2><h3 id="16-1、BTree-索引"><a href="#16-1、BTree-索引" class="headerlink" title="16.1、BTree 索引"></a>16.1、<font color="red">BTree 索引</font></h3><img src="https://i.loli.net/2021/11/02/rLwKxduJzcM5oPC.jpg" style="width:80%" alt="b树索引原理">



<p><font color="red">真实数据存在于叶子节点</font>，即 2、4、8、10、14、17、28、29、40、63、75、79</p>
<p><font color="red">非叶子节点不存储真实的数据，只存储指引搜索方向的数据项</font>，如16、34 并不真实存在于数据表中。</p>
<h3 id="16-2、Hash-索引"><a href="#16-2、Hash-索引" class="headerlink" title="16.2、Hash 索引"></a>16.2、Hash 索引</h3><h3 id="16-3、full-text-全文索引"><a href="#16-3、full-text-全文索引" class="headerlink" title="16.3、full-text 全文索引"></a>16.3、full-text 全文索引</h3><h3 id="16-4、R-Tree-索引"><a href="#16-4、R-Tree-索引" class="headerlink" title="16.4、R-Tree 索引"></a>16.4、R-Tree 索引</h3><h2 id="17、哪些情况需要创建索引"><a href="#17、哪些情况需要创建索引" class="headerlink" title="17、哪些情况需要创建索引"></a>17、哪些情况需要创建索引</h2><ol>
<li><p>逐渐自动建立唯一索引</p>
</li>
<li><p>频繁作为查询条件的字段应该创建索引</p>
</li>
<li><p>查询中与其他表关联的字段，外键关系建立索引</p>
</li>
<li><p>频繁更新的字段不适合创建索引，<font color="orange">因为每次更新不单单是更新了记录，还会更新索引</font></p>
</li>
<li><p>where 条件里用不到的字段不创建索引</p>
</li>
<li><p>单键&#x2F;组合索引的选择问题（在高并发下倾向创建组合索引）</p>
</li>
<li><p>查询中<code>排序</code>的字段，排序字段若通过索引去访问将大大提高排序速度</p>
</li>
</ol>
<h2 id="18、哪些情况不需要创建索引"><a href="#18、哪些情况不需要创建索引" class="headerlink" title="18、哪些情况不需要创建索引"></a>18、哪些情况不需要创建索引</h2><ol>
<li><p>表的记录太少（三百万左右性能开始下降）</p>
</li>
<li><p>经常增删改的表</p>
</li>
<li><p>数据重复且分布平均的表字段，因此应该只为最经常查询和最经常排序的数据列建立索引（如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果）</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表中不重复的数据/表中总数据 = 索引的选择性，这个值越接近于 1，这个索引的效率就高</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="查询截取分析"><a href="#查询截取分析" class="headerlink" title="查询截取分析"></a>查询截取分析</h1><h2 id="19、MySql-Query-Optimizer"><a href="#19、MySql-Query-Optimizer" class="headerlink" title="19、MySql Query Optimizer"></a>19、MySql Query Optimizer</h2><p>MySQL 中专门负责优化 <code>SELECT</code> 语句的<font color="orange">优化器模块</font>，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的 <code>Query </code>提供他认为最优的执行计划。</p>
<h2 id="20、MySQL-常见瓶颈"><a href="#20、MySQL-常见瓶颈" class="headerlink" title="20、MySQL 常见瓶颈"></a>20、MySQL 常见瓶颈</h2><ol>
<li>CPU：CPU 在饱和的时候一般发生在数据装入内存或从磁盘上读取数据的时候</li>
<li>IO：磁盘 I&#x2F;O 瓶颈发生在装入数据远大于内存容量的时候</li>
<li>服务器硬件的性能瓶颈：top，free，iostat 和 vmstat 来查看系统的性能状态</li>
</ol>
<h2 id="21、Explain"><a href="#21、Explain" class="headerlink" title="21、Explain"></a>21、Explain</h2><p><font style="color:;font-size:30px">能干嘛：</font></p>
<ul>
<li>表的读取顺序</li>
<li>数据读取操作的操作类型</li>
<li>哪些索引可以使用</li>
<li>哪些索引被实际使用</li>
<li>表之间的引用</li>
<li>每张表有多少行被优化器查询</li>
</ul>
<p><font style="color:;font-size:30px">怎么用：</font></p>
<p>Explain + SQL 语句</p>
<p>执行计划包含的信息：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>select_type</th>
<th>table</th>
<th>type</th>
<th>possible_keys</th>
<th>key</th>
<th>key_len</th>
<th>ref</th>
<th>rows</th>
<th>extra</th>
</tr>
</thead>
<tbody><tr>
<td>select 查询的序列号，包含一组数字，<br>表示查询中执行 select 子句或操作表的顺序</td>
<td>SIMPLE：简单的 select 查询，查询中不包含子查询或者 UNION：<br>PRIMARY：最外层查询<br>SUBQUERY：子查询<br>DERIVED：在 FROM 列表中包含的子查询被标记为 DERIVED（衍生）MySQL会递归这些子查询，把结果放在临时表中<br>UNION：若第二个 SELECT 出现在 UNION 之后，则被标记为 UNION；若 UNION 包含在 FROM 子句的子查询中，外层 SELECT 将被标记为：DERIVED<br>UNION RESULT：从 UNION 表获取结果的 SELECT</td>
<td></td>
<td>最好到最差依次是：system&gt;const&gt;eq_ref<br>&gt;ref&gt;range&gt;index&gt;all<br></td>
<td>显示可能应用在这张表中的索引，一个或多个。</td>
<td>实际使用的索引，如果为null，则没有使用索引</td>
<td>表示索引中使用的字节数，可通过该列计算查询中使用的索引长度。在不损失精确性的情况下，长度越短越好</td>
<td>显示索引哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值</td>
<td>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数</td>
<td>包含不适合在其它列中显示但十分重要的额外信息</td>
</tr>
<tr>
<td>三种情况：1、id 相同，执行顺序由上至下<br>2、如果是子查询，id 的序号会递增，<br><code>id 值越大优先级越高，越先被执行</code>。<br>3、id 如果相同，可以认为是一组，从上往下顺序<br>执行，在所有组中，id 值越大，优先级越高，<br>越先执行</td>
<td>查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询</td>
<td></td>
<td>一般保证查询在range级别或ref级别</td>
<td>查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用</td>
<td>查询中若使用了覆盖索引，则索引只出现在key列表中</td>
<td>key_len显示的值为索引字段的最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="22、索引优化"><a href="#22、索引优化" class="headerlink" title="22、索引优化"></a>22、索引优化</h2><h3 id="22-1、单表"><a href="#22-1、单表" class="headerlink" title="22.1、单表"></a>22.1、单表</h3><ul>
<li>范围会导致索引失效，组合索引中的字段不要涉及到范围</li>
</ul>
<h3 id="22-2、两表"><a href="#22-2、两表" class="headerlink" title="22.2、两表"></a>22.2、两表</h3><ul>
<li>LEFT JOIN 建立右表索引，LEFT JOIN 条件用于确定如何从右表搜索行，左边一定都有，           所以右边是关键点，一定要建立索引。（右连接类似）</li>
</ul>
<h3 id="22-3、三表"><a href="#22-3、三表" class="headerlink" title="22.3、三表"></a>22.3、三表</h3><ul>
<li>索引最好设置在需要经常查询的字段中</li>
<li>尽可能减少 join 语句中的 NestedLoop 的循环总次数：“永远用小结果集驱动大的结果集”</li>
<li>优先优化 Nested Loop 的内层循环</li>
<li>保证 Join 语句中被驱动表上 join 条件字段已经被索引</li>
<li>当无法保证被驱动表的 join 条件字段被索引且内存资源充足的前提下， 不要太吝惜 joinbuffer 的使用</li>
</ul>
<h3 id="22-4、索引失效"><a href="#22-4、索引失效" class="headerlink" title="22.4、索引失效"></a>22.4、索引失效</h3><ol>
<li>全值匹配我最爱</li>
<li>最佳左前缀法则：如果索引了多列，要遵守最佳左前缀法则，指的是查询从索引的<code>最左前列开始（开头大哥不能死）</code>并且<code>不跳过索引中的列（中间兄弟不能断）</code></li>
<li>不在索引列上做任何的操作（计算、函数、（自动 or 手动）类型转换），会导致索引失效而转向全表扫描</li>
<li>存储引擎不能使用索引中范围条件右边的列</li>
<li>尽量使用覆盖索引（只访问索引的查询（<code>索引列和查询列一致</code>）），减少 select *</li>
<li>mysql 在使用不等于（！&#x3D; 或者 &lt;&gt;）的时候无法使用索引会导致全表扫描</li>
<li>is null , is not null 也无法使用索引</li>
<li>like 以通配符开头（‘%abc…）MySQL 索引失效会变成全表扫描的操作（用<font color="orange">覆盖索引</font>避免全表扫描）</li>
<li><code>字符串不加单引号</code>索引失效</li>
<li>少用 or，用它连接时会索引失效</li>
</ol>
<h3 id="22-5、一般性建议"><a href="#22-5、一般性建议" class="headerlink" title="22.5、一般性建议"></a>22.5、一般性建议</h3><ol>
<li>对于单键索引，尽量选择针对当前 <code>query </code>过滤性更好的索引</li>
<li>在选择组合索引的时候，当前 <code>query </code>中过滤性最好的字段在索引字段顺序中， 位置越靠前越好</li>
<li>在选择组合索引的时候，尽量选择可以能够包含当前 <code>query </code>中的 <code>where </code>字句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整 <code>query </code>的写法来达到选择合适索引的目的</li>
</ol>
<h1 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h1><h2 id="23、一般操作"><a href="#23、一般操作" class="headerlink" title="23、一般操作"></a>23、一般操作</h2><ol>
<li>慢查询的开启并捕获</li>
<li>explain + 慢 sql 分析</li>
<li>show profile 查询 sql 在 mysql 服务器里面的执行细节和生命周期情况</li>
<li>sql 数据库服务器的参数调优</li>
</ol>
<h2 id="24、优化策略"><a href="#24、优化策略" class="headerlink" title="24、优化策略"></a>24、优化策略</h2><ol>
<li><font color="orange">永远小表驱动大表</font></li>
<li>exists or in 的使用，看子查询与主查询谁的数据量更小</li>
<li>order by 关键字优化<ul>
<li>尽量使用 index 方式排序，避免使用 filesort 方式排序<ul>
<li><code>order by</code> 语句使用<font color="orange">索引最左前列</font></li>
<li>使用 <code>where </code>子句与 <code>order by</code> 子句条件列组合满足<font color="orange">索引最左前列</font></li>
</ul>
</li>
<li>尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀</li>
<li>如果不在索引列上，filesort 有两种算法：mysql 就要启动双路排序和单路排序<ul>
<li>双路排序：取一批数据，要对磁盘进行两次扫描</li>
<li>单路排序：从磁盘中查询需要的所有列，按照 order by 列在 buffer 对它们进行排序，然后扫描顺序后的列表进行输出</li>
</ul>
</li>
<li>尽量不要用 <code>select *</code></li>
<li>增大 sort_buffer_size 的值</li>
<li>增大 max_length_for_sort_data 的值</li>
</ul>
</li>
<li>group by 关键字优化<ul>
<li>基本与 group by 一致</li>
</ul>
</li>
</ol>
<h1 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h1><p>mysql 的慢查询是 mysql 提供的一种日志记录，它用来记录在 mysql 中响应时间超过阈值的语句，具体指运行时间超过 long_query_time 值的 sql，则会被记录到慢查询日志中</p>
<p>如果不是调休需要，一般不建议启动该参数，会带来一定的性能影响</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 设置开启慢查询 或者 修改 my.conf 配置文件</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> slow_query_log <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"># 查询日否开启慢查询</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%slow_query_log%&#x27;</span>;</span><br></pre></td></tr></table></figure>





<h1 id="MySql-锁机制"><a href="#MySql-锁机制" class="headerlink" title="MySql 锁机制"></a>MySql 锁机制</h1><p>锁是计算机协调多个进程或线程并发访问某一资源的机制，在数据库中，除传统的计算资源（如 CPU、RAM、I&#x2F;O）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<h2 id="25、锁的分类"><a href="#25、锁的分类" class="headerlink" title="25、锁的分类"></a>25、锁的分类</h2><ol>
<li><p>从对数据的操作类型分：</p>
<ul>
<li>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响</li>
<li>写锁（排它锁）：当前写操作没有完成前，它会阻断其它写锁和读锁</li>
<li><font color="red">读锁会阻塞写，但是不会阻塞读。而写锁则会把读和写都阻塞</font></li>
</ul>
</li>
<li><p>从对数据的操作粒度分：</p>
<ul>
<li><p>表锁（偏读）</p>
</li>
<li><p>行锁（偏写）</p>
<ul>
<li><p>支持事务</p>
<ul>
<li>更新丢失：最后的更新覆盖了其它事务所做的更新</li>
<li>脏读：事务 A 读取到了 事务 B 已修改但尚未提交的数据</li>
<li>不可重复读：事务 A 读取到了事务 B 已提交过的修改数据</li>
<li>幻读：事务 A 读取到了 事务 B 新增的数据</li>
</ul>
</li>
<li><p>无索引行锁升级为表锁（<font color="orange">varchar 类型要加 单引号</font>）                                                                                                                                                                                                                                                                                            </p>
</li>
<li><p>间隙锁</p>
<ul>
<li>当用范围条件而不是相等条件检索数据，并请求共享或排他锁时，<font color="orange">InnoDB 会给符合条件的已有数据记录的索引项加锁</font>；对于键值在条件范围内但并不存在的记录，叫做 “间隙（GAP）”</li>
<li>危害<ul>
<li>query 执行过程中通过范围查找的话，会锁定整个范围内所有的索引键值，即使这个键值并不存在</li>
<li>当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大危害</li>
</ul>
</li>
</ul>
</li>
<li><p>锁定某一行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> xxx ... <span class="keyword">for</span> <span class="keyword">update</span> 锁定某一行后，其它的操作会被阻塞，知道锁定行的会话提交 <span class="keyword">commit</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>优化建议</p>
<ul>
<li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</li>
<li>合理设计索引，尽量缩小锁的范围</li>
<li>尽可能较少检索条件，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可能低级别事务隔离</li>
</ul>
</li>
</ul>
</li>
</ol>
<h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><h2 id="26、复制原理"><a href="#26、复制原理" class="headerlink" title="26、复制原理"></a>26、复制原理</h2><img src="https://img2018.cnblogs.com/blog/1461409/201811/1461409-20181119181300094-111601832.png" style="width:60%">



<p>MySQL 复制过程分成三步：</p>
<ol>
<li>master 将改变记录到二进制日志（binary log），这些记录过程叫做二进制日志事件，binary log events</li>
<li>slave 将 master 的 binary log events 拷贝到它的中继日志（relay log）</li>
<li>slave 重做中继日志中的事件，将改变应用到自己的数据库中，MySQL 复制是异步的且串行化的</li>
</ol>
<h2 id="27、复制的基本原则"><a href="#27、复制的基本原则" class="headerlink" title="27、复制的基本原则"></a>27、复制的基本原则</h2><ol>
<li>每个 slave 只有一个 master</li>
<li>每个 slave 只能有一个唯一的服务器 ID</li>
<li>每个 master 可以有多个 salve</li>
</ol>
<h2 id="28、最大问题"><a href="#28、最大问题" class="headerlink" title="28、最大问题"></a>28、最大问题</h2><p>网络延时</p>
<h2 id="29、常见配置"><a href="#29、常见配置" class="headerlink" title="29、常见配置"></a>29、常见配置</h2><ol>
<li><p>mysql 版本一致且后台以服务运行</p>
</li>
<li><p>主从都配置在【mysqlId】结点下，都是小写</p>
</li>
<li><p>修改配置文件</p>
<ol>
<li><p>主机</p>
<ul>
<li><p>主服务器唯一 ID</p>
</li>
<li><p>启用二进制日志</p>
</li>
<li><p>【可选】启用错误日志</p>
</li>
<li><p>【可选】根目录</p>
</li>
<li><p>【可选】临时目录</p>
</li>
<li><p>【可选】数据目录</p>
</li>
<li><p>read-only &#x3D; 0</p>
</li>
<li><p>【可选】设置不要复制的数据库</p>
</li>
<li><p>【可选】设置需要复制的数据库</p>
</li>
</ul>
</li>
<li><p>从机</p>
<ul>
<li>从服务器唯一 ID</li>
<li>启用二进制文件</li>
</ul>
</li>
</ol>
</li>
<li><p>主机 and 从机 重启 mysql 服务</p>
</li>
</ol>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://hqzqaq.github.io/2022/09/23/mysql-%E9%AB%98%E7%BA%A7/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%AB%98%E7%BA%A7/" rel="tag">高级</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2022/09/23/nginx/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            nginx
          
        </div>
      </a>
    
    
      <a href="/2022/09/23/mysql-%E5%9F%BA%E7%A1%80/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">mysql 基础</div>
      </a>
    
  </nav>

  
   
  
   
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2023
        <i class="ri-heart-fill heart_icon"></i> hqz
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="hqz的博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags/">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/java/">java</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/machineLearning/">机器学习</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/webGIS/">webGIS</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/bigData/">大数据</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/hellogis/">GIS</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/academic/">学术</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories/other/">other</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/friends">友链</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2023/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.staticfile.org/mathjax/2.7.7/MathJax.js"></script>
<script src="https://cdn.staticfile.org/mathjax/2.7.7/config/TeX-AMS-MML_HTMLorMML-full.js"></script>
<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->
 
<script src="/js/clickBoom2.js"></script>
 
<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div>
</body>

</html>